# Design of `nexus-proxy`

## Table of Contents

* [Introduction](#introduction)
* [JSON Web Token (JWT)](#jwt)
  * [JWT Usage in `nexus-proxy`](#json-web-tokens-jwt-jwt-usage-in-nexus-proxy)
* [External Flow](#external-flow)
  * [Authentication Disabled](#external-flow-authentication-disabled)
  * [Authentication Enabled](#external-flow-authentication-enabled)
    * [Browsing the Nexus UI](#external-flow-authentication-enabled-browsing-the-nexus-ui)
    * [Requesting Credentials for CLI Tools](#external-flow-authentication-enabled-requesting-credentials-for-cli-tools)
* [Internal Flow](#internal-flow)
  * [Authentication Disabled](#internal-flow-authentication-disabled)
  * [Authentication Enabled](#internal-flow-authentication-enabled)

<a id="introduction"></a>

## Introduction

When designing `nexus-proxy` we knew we had to support both browser-based and
CLI-based flows (e.g., browsing the Nexus UI and using tools such as Maven or
Docker to upload/download artifacts). We also knew beforehand that we would need
to authenticate Nexus against
[Google Cloud Identity & Access Management](https://cloud.google.com/iam/), but
we wanted to make this authentication optional so that `nexus-proxy` could be
used in simpler scenarios.

This document starts by describing briefly a specific type of token
that `nexus-proxy` uses for authentication, and proceeds into describing both
the external (i.e., from the perspective of the user) and internal flows of
`nexus-proxy`, detailing what happens in each flow when authentication is
disabled or enabled. For simplicity we assume that
`nexus-proxy` is reachable at https://nexus.example.com.

<a id="jwt">

## JSON Web Tokens (JWT)

[JSON Web Token](https://jwt.io), commonly referred to as JWT, ia a type of
token used to convey arbitrary information, also known as _claims_ in a secure
way between two distinct entities (e.g., a client and a server). These claims
are described in JSON and encoded using an URL-safe variant of Base64.Then, a
cryptographic signature of the resulting information is computed and appended to
the the encoded claims, forming a _token_. This token is then sent to a
destination which verifies its authenticity and, in case it is authentic,
decodes the claims and uses them as trusted, verified information.

**NOTE:** The way the signature is computed and verified depends on the
[algorithm](https://auth0.com/blog/json-web-token-signing-algorithms-overview/)
being used.

<a id="json-web-tokens-jwt-jwt-usage-in-nexus-proxy"></a>

### JWT Usage in `nexus-proxy`

`nexus-proxy` uses RS256, which means that the signature is computed using an
RSA private key and the SHA-256 algorithm, and verified using the corresponding
RSA public key. The tokens generated by `nexus-proxy` carry the following
claims:

* `uid` — The email address of the authenticated user.
* `iat` — The timestamp at which the token was issued.
* `exp` — The timestamp at which the token will expire.
* `aud` — The token's intended audience, i.e., the domain names being in use.

In practice this means that a token generated by `nexus-proxy` will look like

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1aWQiOiJqb2huLmRvZUBleGFtcGxlLmNv
bSIsImlhdCI6MTUwMzA1NTI3NiwiZXhwIjoxNTM0NTkxMjc2LCJhdWQiOlsiY29udGFpbmVyc
y5leGFtcGxlLmNvbSIsIm5leHVzLmV4YW1wbGUuY29tIl19.14dRJRxkwAp0iwm-XcxuVNV5S
Ixc78ipcvg_kJAjeEseeKlvpsIQxv2TEOInLGkxUhppnwpV5ZYuNrSmKP_bdHifubCdIglvP2
iK41RvVgSNmvHy8SATzeHhtPOK3EyCc9SyLPxYTfbsjqXxClqPuvzkn0QMdJRn36sJIfjAzmc
```

The JWT tokens generated by `nexus-proxy` are valid for one year. Further
details can be found
[below](#external-flow-authentication-enabled-requesting-credentials-for-cli-tools).

<a id="external-flow"></a>

## External Flow

<a id="external-flow-authentication-disabled"></a>

### Authentication Disabled

When authentication is disabled, `nexus-proxy` is transparent to the user. The
following flowchart details a user's experience when browsing
https://nexus.example.com:

<p align="center">
  <img alt="nexus-proxy-external-flow-auth-disabled" src="./img/nexus-proxy-external-flow-auth-disabled.png">
</p>

<a id="external-flow-authentication-enabled"></a>

### Authentication Enabled

When authentication is enabled, `nexus-proxy` requires that one authenticates
themselves against Google Cloud IAM.

<a id="external-flow-authentication-enabled-browsing-the-nexus-ui"></a>

#### Browsing the Nexus UI

The following flowchart details a user's experience when browsing
https://nexus.example.com:

<p align="center">
  <img alt="nexus-proxy-external-flow-ui-auth-enabled" src="./img/nexus-proxy-external-flow-ui-auth-enabled.png">
</p>

<a id="external-flow-authentication-enabled-requesting-credentials-for-cli-tools"></a>

#### Requesting Credentials for CLI Tools

In order to use tools such as Maven or Docker, one must obtain a specific set of
credentials. This is necessary so that one doesn't have to use their Google
organization credentials or a manually-obtained Google authentication token in
their configuration files. As mentioned above, the credentials generated by
`nexus-proxy` are JWT tokens and are valid for one year (unless organization
membership is revoked before this period).

The following flowchart details a user's experience when visiting https://nexus.example.com/cli/credentials:

<p align="center">
  <img alt="nexus-proxy-external-flow-jwt-auth-enabled" src="./img/nexus-proxy-external-flow-jwt-auth-enabled.png">
</p>

One must then configure their tools to use these credentials. Detailed steps can
be found
[here](https://github.com/travelaudience/kubernetes-nexus/tree/master/docs/usage).

**ATTENTION:** These credentials are not renewed automatically. Whenever one's JWT
expires one must obtain a new one by visiting
https://nexus.example.com/cli/credentials again.

**ATTENTION:** Every visit to https://nexus.example.com/cli/credentials will return a
different JWT, as the creation and expiration dates are encoded in the token
itself. One may use different JWTs in different tools but must be aware that
they will expire at different moments.

<a id="internal-flow"></a>

## Internal Flow

<a id="internal-flow-authentication-disabled"></a>

### Authentication Disabled

When authentication is disabled, `nexus-proxy` proxies requests to Nexus and
responds to health-checks on its behalf. An health-check is any HTTP request
made to `/` by user-agents matching a configurable regular expression. These
must usually be responded with `200 OK`, and `nexus-proxy` ensures that.

The following flowchart details the flow of an HTTP request made to
`nexus-proxy` when authentication is disabled:

<p align="center">
  <img alt="nexus-proxy-internal-flow-auth-disabled" src="./img/nexus-proxy-internal-flow-auth-disabled.png">
</p>

<a id="internal-flow-authentication-enabled"></a>

### Authentication Enabled

When authentication is enabled, `nexus-proxy` performs the following high-level
tasks:

* Responds to health-checks as described
  [above](#internal-flow-authentication-disabled).
* Performs an OAuth2 "_authorization code_" flow in order to establish a
  session.
* Ensure that only authenticated users can access protected resources in both
  in-browser and CLI flows.
* Partially implements the authentication flows of Maven and Docker
  repositories.

This last item is necessary because Maven and Docker expect HTTP Basic
authentication (as opposed to the Bearer Token/JWT authentication which we are
using). Also, Docker expects specific response headers at a specific endpoint,
according to the
[Docker Registry HTTP API V2](https://docs.docker.com/registry/spec/api/). As
such, and since `nexus-proxy` stands between Maven/Docker and Nexus, this part
of the authentication flow had to be implemented in the proxy.

The following flowchart details the flow of an HTTP request made to
`nexus-proxy` when authentication is enabled:

<p align="center">
  <img alt="nexus-proxy-internal-flow-auth-enabled" src="./img/nexus-proxy-internal-flow-auth-enabled.png">
</p>
